<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestionnaire d'Acc√®s Google Sheets</title>
  
  <style>
    /* ==================================================================================
       CONFIGURATION DES TH√àMES
       ================================================================================== */
    :root[data-theme="theme1"] {
      --primary-color: #2196F3; --secondary-color: #4CAF50; --accent-color: #81C784;
      --background-color: #F5F9FF; --text-color: #263238;
      --tab1-color: #42A5F5; --tab2-color: #66BB6A; --tab3-color: #26A69A;
    }
    :root[data-theme="theme2"] {
      --primary-color: #0288D1; --secondary-color: #00ACC1; --accent-color: #4DD0E1;
      --background-color: #E0F7FA; --text-color: #01579B;
      --tab1-color: #0288D1; --tab2-color: #00ACC1; --tab3-color: #00838F;
    }
    :root[data-theme="theme3"] {
      --primary-color: #388E3C; --secondary-color: #00897B; --accent-color: #66BB6A;
      --background-color: #E8F5E9; --text-color: #1B5E20;
      --tab1-color: #43A047; --tab2-color: #26A69A; --tab3-color: #00695C;
    }
    
    /* STYLES G√âN√âRAUX & RESET */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background-color); color: var(--text-color);
      padding: 20px; transition: background-color 0.3s ease;
    }
    
    /* EN-T√äTE */
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { font-size: 2.5em; color: var(--primary-color); margin-bottom: 10px; font-weight: 600; }
    .header .date { font-size: 1.1em; opacity: 0.8; }
    
    /* SECTION CONNEXION */
    .login-section {
      display: flex; align-items: flex-end; justify-content: space-between;
      max-width: 1200px; margin: 0 auto 30px auto; padding: 20px;
      background-color: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex-wrap: wrap; gap: 15px;
    }
    .login-fields { display: flex; align-items: flex-end; gap: 15px; flex: 1; min-width: 300px; }
    .input-group { display: flex; flex-direction: column; gap: 5px; }
    .input-group label { font-size: 0.9em; font-weight: 600; }
    .input-group input {
      padding: 10px 15px; border: 2px solid var(--accent-color); border-radius: 5px;
      font-size: 1em; width: 200px; transition: border-color 0.3s ease;
    }
    .input-group input:focus { outline: none; border-color: var(--primary-color); }
    
    /* BOUTONS */
    .btn {
      padding: 10px 25px; border: none; border-radius: 5px; font-size: 1em; font-weight: 600;
      cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: white;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .btn-login { background-color: var(--primary-color); }
    .btn-register { background-color: var(--secondary-color); }
    .btn-logout { background-color: #F44336; }
    
    /* NAVIGATION ONGLETS */
    .tab-container { max-width: 1200px; margin: 0 auto; }
    .tab-buttons { display: flex; gap: 5px; margin-bottom: 0; }
    .tab-button {
      padding: 15px 30px; border: none; border-radius: 10px 10px 0 0;
      font-size: 1.1em; font-weight: bold; cursor: pointer; color: white; flex: 1;
      background-color: #ccc; transition: all 0.3s ease;
    }
    .tab-button.active { transform: translateY(-5px); box-shadow: 0 -4px 10px rgba(0,0,0,0.2); }
    .tab-button.instructions { background-color: var(--tab1-color); }
    .tab-button.users { background-color: var(--tab2-color); }
    .tab-button.admin { background-color: var(--tab3-color); }
    
    .tab-content {
      background-color: white; padding: 30px; border-radius: 0 10px 10px 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-height: 400px;
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* COMPOSANTS UI SPECIFIQUES */
    .status-message {
      margin-top: 15px; padding: 12px 15px; border-radius: 5px; font-weight: 600;
      text-align: center; display: none;
    }
    .status-message.success { background-color: #C8E6C9; color: #2E7D32; border: 2px solid #4CAF50; }
    .status-message.error { background-color: #FFCDD2; color: #C62828; border: 2px solid #F44336; }
    
    /* TH√àMES */
    .theme-switcher { display: flex; gap: 15px; align-items: center; }
    .theme-circle { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; transition: transform 0.3s; }
    .theme-circle:hover, .theme-circle.active { transform: scale(1.2); border: 2px solid var(--text-color); }
    .theme1-circle { background: linear-gradient(135deg, #2196F3 50%, #4CAF50 50%); }
    .theme2-circle { background: linear-gradient(135deg, #0288D1 50%, #00ACC1 50%); }
    .theme3-circle { background: linear-gradient(135deg, #388E3C 50%, #00897B 50%); }

    /* FOOTER */
    .site-footer {
      max-width: 1200px; margin: 40px auto 20px; padding: 25px; text-align: center;
      background: white; border-radius: 10px; border-top: 4px solid var(--primary-color);
    }

    /* MODALES */
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white; margin: 10% auto; padding: 25px; border-radius: 10px;
      width: 50%; max-width: 600px; position: relative;
    }
    .close-modal { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    
    /* AUTRES STYLES UTILITAIRES (H√©rit√©s du design original) */
    .doc-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
  </style>
</head>

<body>
  <script>
    // Initialisation du th√®me
    document.documentElement.setAttribute('data-theme', localStorage.getItem('themeChoisi') || 'theme1');
  </script>

  <div class="header">
    <h1>Gestionnaire d'Acc√®s Google Sheets</h1>
    <div class="date" id="dateActuelle"></div>
  </div>

  <div class="login-section">
    <div class="login-fields">
      <div class="input-group">
        <label for="email">Email Gmail</label>
        <input type="email" id="email" placeholder="votre@gmail.com">
      </div>
      <div class="input-group">
        <label for="password">Mot de passe</label>
        <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button class="btn btn-login" onclick="gererConnexion()">Connexion</button>
    </div>
    
    <div>
      <button class="btn btn-register" onclick="ouvrirModalInscription()">Cr√©er un compte</button>
    </div>
    
    <div class="theme-switcher">
      <div class="theme-circle theme1-circle" onclick="changerTheme('theme1')" title="Th√®me Classique"></div>
      <div class="theme-circle theme2-circle" onclick="changerTheme('theme2')" title="Th√®me Oc√©an"></div>
      <div class="theme-circle theme3-circle" onclick="changerTheme('theme3')" title="Th√®me For√™t"></div>
    </div>
  </div>

  <div class="tab-container">
    <div class="tab-buttons">
      <button class="tab-button instructions active" onclick="changerOnglet('instructions')">Instructions</button>
      <button class="tab-button users" onclick="changerOnglet('users')">Espace Utilisateur</button>
      <button class="tab-button admin" onclick="changerOnglet('admin')">Administration</button>
    </div>
    
    <div class="tab-content">
      
      <div class="tab-panel active" id="instructions-panel">
        <h2 style="color: var(--primary-color);">Guide d'Utilisation</h2>
        <div style="background-color: #FFF3E0; border-left: 5px solid #FF9800; padding: 15px; margin: 20px 0;">
          <strong>‚ö†Ô∏è IMPORTANT :</strong> Vous devez poss√©der un compte <strong>Google Gmail</strong> pour utiliser ce syst√®me.
        </div>
        <div id="conteneur-documentation">Chargement de la documentation...</div>
      </div>
      
      <div class="tab-panel" id="users-panel">
        <div id="verrou-user" style="text-align: center; padding: 40px;">
          <h2>üîí Acc√®s Restreint</h2>
          <p>Veuillez vous connecter pour acc√©der √† vos feuilles de calcul.</p>
        </div>
        
        <div id="contenu-user" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="color: var(--tab2-color);">Vos Feuilles de Calcul</h2>
            <button class="btn btn-logout" onclick="gererDeconnexion()">D√©connexion</button>
          </div>
          
          <div style="display:flex; gap:30px;">
            <div style="flex:1;">
              <h3>Demander un acc√®s</h3>
              <div class="input-group" style="margin-top:15px;">
                <label>S√©lectionner un fichier :</label>
                <select id="select-feuille" style="padding:10px; border-radius:5px; border:2px solid var(--accent-color);">
                  <option value="">-- Chargement... --</option>
                </select>
              </div>
              <button class="btn" style="background-color: var(--secondary-color); margin-top:15px;" onclick="demanderAcces()">
                Ouvrir la feuille
              </button>
              <div id="msg-acces" class="status-message"></div>
            </div>
            
            <div style="flex:1; border-left:2px solid #eee; padding-left:30px;">
              <h3>Actuellement utilis√©</h3>
              <div id="liste-utilisation" style="margin-top:15px; font-style:italic; color:#666;">
                Aucune feuille en cours d'utilisation.
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="tab-panel" id="admin-panel">
        <div id="verrou-admin" style="text-align: center; padding: 40px;">
          <h2>üîê Acc√®s Administrateur</h2>
          <p>Cette section est r√©serv√©e aux administrateurs connect√©s.</p>
        </div>
        
        <div id="contenu-admin" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="color: var(--tab3-color);">Tableau de Bord Admin</h2>
            <button class="btn btn-logout" onclick="gererDeconnexion()">D√©connexion</button>
          </div>
          <p>Bienvenue dans l'interface de gestion. Utilisez les outils ci-dessous pour g√©rer les utilisateurs et les fichiers.</p>
          
          <div style="margin-top:20px; padding:20px; background:#f9f9f9; border-radius:8px;">
            <h3>√âtat du Syst√®me</h3>
            <p id="stats-admin">Chargement des statistiques...</p>
            <button class="btn" style="background-color: var(--primary-color); margin-top:10px;" onclick="chargerDonneesAdmin()">
              üîÑ Actualiser les donn√©es
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div id="modal-inscription" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="fermerModalInscription()">&times;</span>
      <h2>Cr√©er un compte</h2>
      <p>Votre inscription devra √™tre valid√©e par un administrateur.</p>
      <form onsubmit="soumettreInscription(event)">
        <div class="input-group" style="margin-bottom:15px;">
          <label>Nom Complet</label>
          <input type="text" id="reg-nom" required style="width:100%;">
        </div>
        <div class="input-group" style="margin-bottom:15px;">
          <label>Email Gmail</label>
          <input type="email" id="reg-email" required style="width:100%;">
        </div>
        <div class="input-group" style="margin-bottom:15px;">
          <label>Mot de passe (min 8 car.)</label>
          <input type="password" id="reg-mdp" required minlength="8" style="width:100%;">
        </div>
        <button type="submit" class="btn btn-register" style="width:100%;">S'inscrire</button>
      </form>
    </div>
  </div>

  <footer class="site-footer">
    <p>Conception et D√©veloppement par <strong>Fabrice Faucheux</strong></p>
    <p style="font-size:0.9em; margin-top:5px;">
      Propuls√© par Google Apps Script &bull; <a href="#" style="color:var(--primary-color);">Contact Support</a>
    </p>
  </footer>

  <script>
    // √âTAT GLOBAL
    let utilisateurCourant = null;

    // INITIALISATION
    window.onload = function() {
      afficherDate();
      chargerDocumentation();
      
      // V√©rification session existante
      const sessionSauvegardee = sessionStorage.getItem('sessionUtilisateur');
      if (sessionSauvegardee) {
        utilisateurCourant = JSON.parse(sessionSauvegardee);
        deverrouillerInterface(utilisateurCourant);
      }
    };

    function afficherDate() {
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('dateActuelle').textContent = new Date().toLocaleDateString('fr-FR', options);
    }

    // GESTION DES ONGLETS
    function changerOnglet(nomOnglet) {
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      
      document.getElementById(nomOnglet + '-panel').classList.add('active');
      document.querySelector('.tab-button.' + nomOnglet).classList.add('active');
    }

    function changerTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('themeChoisi', theme);
    }

    // CHARGEMENT DOCUMENTATION
    function chargerDocumentation() {
      google.script.run
        .withSuccessHandler(html => {
          document.getElementById('conteneur-documentation').innerHTML = html;
        })
        .recupererHtmlDocumentation();
    }

    // CONNEXION
    function gererConnexion() {
      const email = document.getElementById('email').value;
      const mdp = document.getElementById('password').value;
      const btn = document.querySelector('.btn-login');

      if (!email || !mdp) {
        alert("Veuillez remplir tous les champs.");
        return;
      }

      const texteOriginal = btn.textContent;
      btn.textContent = "Connexion...";
      btn.disabled = true;

      google.script.run
        .withSuccessHandler(resultat => {
          btn.textContent = texteOriginal;
          btn.disabled = false;
          
          if (resultat.succes) {
            utilisateurCourant = resultat;
            sessionStorage.setItem('sessionUtilisateur', JSON.stringify(resultat));
            deverrouillerInterface(resultat);
            alert("Bienvenue !");
          } else {
            alert("Erreur : " + resultat.message);
          }
        })
        .withFailureHandler(err => {
          btn.textContent = texteOriginal;
          btn.disabled = false;
          alert("Erreur syst√®me : " + err.message);
        })
        .connecterUtilisateur(email, mdp);
    }

    function deverrouillerInterface(user) {
      // Nettoyage champs login
      document.getElementById('email').value = "";
      document.getElementById('password').value = "";

      // D√©verrouillage User
      document.getElementById('verrou-user').style.display = 'none';
      document.getElementById('contenu-user').style.display = 'block';
      changerOnglet('users');
      chargerFeuillesDisponibles();

      // D√©verrouillage Admin
      if (user.estAdmin) {
        document.getElementById('verrou-admin').style.display = 'none';
        document.getElementById('contenu-admin').style.display = 'block';
        chargerDonneesAdmin();
      }
    }

    // D√âCONNEXION
    function gererDeconnexion() {
      if (!confirm("Voulez-vous vraiment vous d√©connecter ?")) return;

      google.script.run
        .withSuccessHandler(() => {
          sessionStorage.removeItem('sessionUtilisateur');
          window.location.reload(); // Rechargement propre
        })
        .deconnecterUtilisateur(utilisateurCourant.jetonSession);
    }

    // GESTION INSCRIPTION
    function ouvrirModalInscription() { document.getElementById('modal-inscription').style.display = 'block'; }
    function fermerModalInscription() { document.getElementById('modal-inscription').style.display = 'none'; }

    function soumettreInscription(e) {
      e.preventDefault();
      const nom = document.getElementById('reg-nom').value;
      const email = document.getElementById('reg-email').value;
      const mdp = document.getElementById('reg-mdp').value;

      google.script.run
        .withSuccessHandler(res => {
          if (res.succes) {
            alert(res.message);
            fermerModalInscription();
          } else {
            alert("Erreur : " + res.message);
          }
        })
        .inscrireNouvelUtilisateur(email, mdp, nom);
    }

    // FONCTIONS UTILISATEUR
    function chargerFeuillesDisponibles() {
      const select = document.getElementById('select-feuille');
      // Pour cet exemple, on utilise une fonction g√©n√©rique ou adapt√©e
      // On assume que le backend a une fonction 'recupererFeuillesDisponibles'
      // Sinon on peut simuler l'appel ici.
      select.innerHTML = '<option>Chargement...</option>';
      
      // Note : Vous devrez impl√©menter recupererFeuillesDisponibles(jeton) dans Code.gs 
      // ou utiliser recupererDonneesTableauBord et filtrer.
      // Ici j'utilise le pattern standard.
      google.script.run
        .withSuccessHandler(res => {
           select.innerHTML = '<option value="">-- Choisir une feuille --</option>';
           if(res.succes && res.feuilles) {
             res.feuilles.forEach(f => {
               const opt = document.createElement('option');
               opt.value = f.id;
               opt.textContent = f.nom + (f.utilisateurActuel ? " (Occup√©)" : "");
               if (f.utilisateurActuel) opt.disabled = true;
               select.appendChild(opt);
             });
           }
        })
        // Fallback si la fonction n'est pas encore cr√©√©e dans Code.gs, on simule :
        .withFailureHandler(() => {
           select.innerHTML = '<option disabled>Erreur chargement liste</option>';
        })
        .recupererFeuillesDisponibles(utilisateurCourant.jetonSession); 
    }

    function demanderAcces() {
      const idFeuille = document.getElementById('select-feuille').value;
      if (!idFeuille) return;
      
      const msgDiv = document.getElementById('msg-acces');
      msgDiv.style.display = 'block';
      msgDiv.className = 'status-message';
      msgDiv.textContent = "Demande d'acc√®s en cours...";

      google.script.run
        .withSuccessHandler(res => {
          if (res.succes) {
            msgDiv.className = 'status-message success';
            msgDiv.textContent = res.message;
            window.open(res.urlFeuille, '_blank');
            chargerFeuillesDisponibles(); // Rafraichir la liste
          } else {
            msgDiv.className = 'status-message error';
            msgDiv.textContent = res.message;
          }
        })
        .demanderAccesFeuille(idFeuille, utilisateurCourant.jetonSession);
    }

    // FONCTIONS ADMIN
    function chargerDonneesAdmin() {
      if (!utilisateurCourant.estAdmin) return;
      
      document.getElementById('stats-admin').textContent = "R√©cup√©ration des donn√©es...";
      
      google.script.run
        .withSuccessHandler(res => {
          if (res.succes) {
            document.getElementById('stats-admin').innerHTML = `
              <strong>Utilisateurs Inscrits :</strong> ${res.utilisateurs.length}<br>
              <strong>Feuilles G√©r√©es :</strong> ${res.feuilles.length}<br>
              <strong>Stockage utilis√© :</strong> ${res.stockage.pourcentageUtilise}%
            `;
          }
        })
        .recupererDonneesTableauBord(utilisateurCourant.jetonSession);
    }

    // Fermeture modal au clic ext√©rieur
    window.onclick = function(event) {
      if (event.target == document.getElementById('modal-inscription')) {
        fermerModalInscription();
      }
    }
  </script>
</body>
</html>
