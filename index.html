<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestionnaire d'Acc√®s Google Sheets</title>
  
  <style>
    /* ==================================================================================
       CONFIGURATION DES TH√àMES
       ================================================================================== */
    
    /* THEME 1 - Bleu/Vert (D√©faut) */
    :root[data-theme="theme1"] {
      --primary-color: #2196F3;
      --secondary-color: #4CAF50;
      --accent-color: #81C784;
      --background-color: #F5F9FF;
      --text-color: #263238;
      --tab1-color: #42A5F5;
      --tab2-color: #66BB6A;
      --tab3-color: #26A69A;
    }
    
    /* THEME 2 - Oc√©an (Bleu/Cyan) */
    :root[data-theme="theme2"] {
      --primary-color: #0288D1;
      --secondary-color: #00ACC1;
      --accent-color: #4DD0E1;
      --background-color: #E0F7FA;
      --text-color: #01579B;
      --tab1-color: #0288D1;
      --tab2-color: #00ACC1;
      --tab3-color: #00838F;
    }
    
    /* THEME 3 - For√™t (Vert/√âmeraude) */
    :root[data-theme="theme3"] {
      --primary-color: #388E3C;
      --secondary-color: #00897B;
      --accent-color: #66BB6A;
      --background-color: #E8F5E9;
      --text-color: #1B5E20;
      --tab1-color: #43A047;
      --tab2-color: #26A69A;
      --tab3-color: #00695C;
    }
    
    /* ==================================================================================
       STYLES G√âN√âRAUX
       ================================================================================== */
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      padding: 20px;
      transition: background-color 0.3s ease;
    }
    
    /* EN-T√äTE */
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { font-size: 2.5em; color: var(--primary-color); margin-bottom: 10px; font-weight: 600; }
    .header .date { font-size: 1.1em; opacity: 0.8; }
    
    /* CONNEXION */
    .login-section {
      display: flex; align-items: flex-end; justify-content: space-between;
      max-width: 1200px; margin: 0 auto 30px auto; padding: 20px;
      background-color: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      flex-wrap: wrap; gap: 15px;
    }
    .login-fields { display: flex; align-items: flex-end; gap: 15px; flex: 1; min-width: 300px; }
    
    .input-group { display: flex; flex-direction: column; gap: 5px; }
    .input-group label { font-size: 0.9em; font-weight: 600; }
    .input-group input {
      padding: 10px 15px; border: 2px solid var(--accent-color); border-radius: 5px;
      font-size: 1em; width: 200px; transition: border-color 0.3s ease;
    }
    .input-group input:focus { outline: none; border-color: var(--primary-color); }
    
    /* BOUTONS */
    .btn {
      padding: 10px 25px; border: none; border-radius: 5px; font-size: 1em; font-weight: 600;
      cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); color: white;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
    .btn-login { background-color: var(--primary-color); }
    .btn-register { background-color: var(--secondary-color); }
    .btn-logout { background-color: #F44336; }
    .btn-logout:hover { background-color: #D32F2F; }
    
    /* ACCORD√âON DOCUMENTATION */
    .accordion-item {
      background-color: white; border-radius: 8px; margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;
    }
    .accordion-header {
      padding: 20px 25px; cursor: pointer; display: flex; justify-content: space-between;
      align-items: center; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white; font-weight: 600; font-size: 1.1em;
    }
    .accordion-header:hover { opacity: 0.9; }
    .accordion-content {
      max-height: 0; overflow: hidden; transition: max-height 0.4s ease, padding 0.4s ease;
      padding: 0 25px; background-color: white;
    }
    .accordion-content.active {
      max-height: 5000px; padding: 25px; border-top: 2px solid var(--accent-color);
    }
    .accordion-icon { font-size: 1.5em; transition: transform 0.3s ease; }
    .accordion-header.active .accordion-icon { transform: rotate(45deg); }

    /* STYLES DOCUMENTATION INJECT√âS */
    .doc-section h3 { color: var(--primary-color); border-bottom: 3px solid var(--accent-color); padding-bottom: 10px; margin-bottom: 15px; }
    .doc-section h4 { color: var(--secondary-color); margin-top: 20px; margin-bottom: 10px; }
    .concept-box { padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 5px solid; }
    .concept-box.problem { background-color: #FFEBEE; border-left-color: #F44336; color: #C62828; }
    .concept-box.solution { background-color: #E8F5E9; border-left-color: #4CAF50; color: #2E7D32; }
    .doc-list { padding-left: 20px; line-height: 1.6; }
    .doc-list li { margin-bottom: 8px; }
    .security-feature { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--primary-color); }

    /* ONGLETS */
    .tab-container { max-width: 1200px; margin: 0 auto; }
    .tab-buttons { display: flex; gap: 5px; margin-bottom: 0; }
    .tab-button {
      padding: 15px 30px; border: none; border-radius: 10px 10px 0 0;
      font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s ease;
      background-color: white; color: white; flex: 1; text-align: left;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
    }
    .tab-button.instructions { background-color: var(--tab1-color); }
    .tab-button.users { background-color: var(--tab2-color); }
    .tab-button.admin { background-color: var(--tab3-color); }
    .tab-button.active { transform: translateY(-5px); box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2); }
    
    .tab-content {
      background-color: white; padding: 30px; border-radius: 0 10px 10px 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); min-height: 400px;
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    
    /* SWITCHER THEME */
    .theme-switcher { display: flex; gap: 15px; align-items: center; }
    .theme-circle { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; transition: transform 0.3s ease; }
    .theme-circle:hover { transform: scale(1.2); }
    .theme1-circle { background: linear-gradient(135deg, #2196F3 50%, #4CAF50 50%); }
    .theme2-circle { background: linear-gradient(135deg, #0288D1 50%, #00ACC1 50%); }
    .theme3-circle { background: linear-gradient(135deg, #388E3C 50%, #00897B 50%); }

    /* MODAL */
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white; margin: 10% auto; padding: 25px; border-radius: 10px; width: 90%; max-width: 500px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s;
    }
    @keyframes slideIn { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
    .close-modal { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
    .close-modal:hover { color: black; }

    /* FOOTER */
    .site-footer {
      max-width: 1200px; margin: 40px auto 20px; padding: 25px 20px; text-align: center;
      background-color: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-top: 4px solid var(--primary-color);
    }
    
    /* UTILITAIRES */
    .status-message {
      margin-top: 15px; padding: 12px; border-radius: 5px; text-align: center; font-weight: bold; display: none;
    }
    .status-message.success { background-color: #C8E6C9; color: #2E7D32; border: 1px solid #4CAF50; }
    .status-message.error { background-color: #FFCDD2; color: #C62828; border: 1px solid #F44336; }
  </style>
</head>

<body>
  <script>
    // Appliquer le th√®me par d√©faut
    document.documentElement.setAttribute('data-theme', 'theme1');
  </script>

  <div class="header">
    <h1>Gestionnaire d'Acc√®s Google Sheets</h1>
    <div class="date" id="currentDate"></div>
  </div>

  <div class="login-section">
    <div class="login-fields">
      <div class="input-group">
        <label for="email">Email Gmail</label>
        <input type="email" id="email" placeholder="votre@gmail.com">
      </div>
      <div class="input-group">
        <label for="password">Mot de passe</label>
        <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button class="btn btn-login" onclick="handleLogin()">Connexion</button>
    </div>
    
    <div>
      <button class="btn btn-register" onclick="openRegistrationModal()">S'inscrire</button>
    </div>
    
    <div class="theme-switcher">
      <div class="theme-circle theme1-circle" onclick="switchTheme('theme1')" title="Th√®me Classique"></div>
      <div class="theme-circle theme2-circle" onclick="switchTheme('theme2')" title="Th√®me Oc√©an"></div>
      <div class="theme-circle theme3-circle" onclick="switchTheme('theme3')" title="Th√®me For√™t"></div>
    </div>
  </div>

  <div class="tab-container">
    <div class="tab-buttons">
      <button class="tab-button instructions active" onclick="switchTab('instructions')">Instructions</button>
      <button class="tab-button users" onclick="switchTab('users')">Espace Utilisateur</button>
      <button class="tab-button admin" onclick="switchTab('admin')">Administration</button>
    </div>
    
    <div class="tab-content">
      
      <div class="tab-panel active" id="instructions-panel">
        <h2 style="color: var(--primary-color); margin-bottom: 20px;">Guide d'Utilisation</h2>
        
        <div style="background-color: #FFF3E0; border-left: 5px solid #FF9800; padding: 15px; margin-bottom: 20px;">
          <strong>‚ö†Ô∏è IMPORTANT :</strong> Vous devez poss√©der un compte <strong>Google Gmail</strong> pour utiliser ce syst√®me.
        </div>

        <div id="documentation-container">
          <p style="text-align:center; color:#666;">Chargement de la documentation...</p>
        </div>
      </div>
      
      <div class="tab-panel" id="users-panel">
        <div id="user-lock-screen" style="text-align: center; padding: 40px;">
          <div style="font-size: 4em; margin-bottom: 20px;">üîí</div>
          <h2>Acc√®s Restreint</h2>
          <p>Veuillez vous connecter pour acc√©der √† vos feuilles de calcul.</p>
        </div>

        <div id="user-content" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--accent-color); padding-bottom:10px; margin-bottom:20px;">
            <h2 style="color: var(--tab2-color);">Espace Utilisateur</h2>
            <button class="btn btn-logout" onclick="handleLogout()">D√©connexion</button>
          </div>

          <div style="display:flex; gap:30px; flex-wrap:wrap;">
            <div style="flex:1; min-width:300px;">
              <h3 style="color:var(--primary-color);">Demander l'acc√®s</h3>
              <div class="input-group" style="margin-top:15px;">
                <label>S√©lectionnez une feuille :</label>
                <select id="sheet-select" style="padding:10px; border:2px solid var(--accent-color); border-radius:5px; width:100%;">
                  <option value="">-- Choisir une feuille --</option>
                </select>
              </div>
              <button class="btn" style="background-color:var(--secondary-color); margin-top:15px; width:100%;" onclick="requestAccess()">
                Ouvrir la feuille
              </button>
              <div id="user-msg" class="status-message"></div>
            </div>

            <div style="flex:1; min-width:300px; background-color:#f9f9f9; padding:20px; border-radius:8px;">
              <h3 style="color:var(--primary-color);">Besoin d'aide ?</h3>
              <p style="margin:10px 0;">Probl√®me d'acc√®s ou demande sp√©cifique ?</p>
              <button class="btn" style="background-color:var(--primary-color);" onclick="alert('Fonctionnalit√© de contact √† venir.')">
                Contacter l'Admin
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="tab-panel" id="admin-panel">
        <div id="admin-lock-screen" style="text-align: center; padding: 40px;">
          <div style="font-size: 4em; margin-bottom: 20px;">üîê</div>
          <h2>Acc√®s Administrateur</h2>
          <p>Section r√©serv√©e aux administrateurs connect√©s.</p>
        </div>

        <div id="admin-content" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--accent-color); padding-bottom:10px; margin-bottom:20px;">
            <h2 style="color: var(--tab3-color);">Tableau de Bord Admin</h2>
            <button class="btn btn-logout" onclick="handleLogout()">D√©connexion</button>
          </div>
          
          <div style="background-color:#f0f0f0; padding:20px; border-radius:8px; margin-bottom:20px;">
            <h3>√âtat du Syst√®me</h3>
            <div id="admin-stats" style="margin-top:10px;">Chargement des donn√©es...</div>
            <button class="btn" style="background-color:var(--primary-color); margin-top:10px;" onclick="loadAdminData()">
              Actualiser
            </button>
          </div>
          
          <p style="font-style:italic;">(Interface d'administration compl√®te disponible dans les versions futures)</p>
        </div>
      </div>

    </div>
  </div>

  <div id="reg-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeRegistrationModal()">&times;</span>
      <h2 style="color:var(--secondary-color);">Cr√©er un compte</h2>
      <p style="margin-bottom:15px; font-size:0.9em; color:#666;">Votre compte devra √™tre valid√© par un administrateur.</p>
      
      <div class="input-group" style="margin-bottom:10px;">
        <label>Nom Complet</label>
        <input type="text" id="reg-name" style="width:100%;">
      </div>
      <div class="input-group" style="margin-bottom:10px;">
        <label>Email Gmail</label>
        <input type="email" id="reg-email" style="width:100%;">
      </div>
      <div class="input-group" style="margin-bottom:20px;">
        <label>Mot de passe (8+ caract√®res)</label>
        <input type="password" id="reg-pass" style="width:100%;">
      </div>
      
      <button class="btn btn-register" style="width:100%;" onclick="submitRegistration()">S'inscrire</button>
    </div>
  </div>

  <footer class="site-footer">
    <p class="footer-text">
      Concept par <strong>Fabrice Faucheux</strong>
    </p>
    <p class="footer-contact">
      <a href="#" style="color:var(--secondary-color); text-decoration:none;">Support Technique</a>
    </p>
  </footer>

  <script>
    // Variables globales
    let currentUser = null;
    let docSections = {};

    // Initialisation
    window.onload = function() {
      // Date
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('currentDate').textContent = new Date().toLocaleDateString('fr-FR', options);
      
      // Chargement Documentation
      loadDocumentation();
      
      // Restauration Session
      const savedSession = sessionStorage.getItem('userSession');
      if (savedSession) {
        currentUser = JSON.parse(savedSession);
        unlockInterface(currentUser);
      }
    };

    // --- GESTION DOCUMENTATION ---
    function loadDocumentation() {
      google.script.run.withSuccessHandler(function(html) {
        // Parsing du HTML re√ßu pour cr√©er les accord√©ons
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const container = document.getElementById('documentation-container');
        container.innerHTML = ''; // Clear loading msg

        const sections = [
          {id: 'doc-what-is', title: 'üìã Qu\'est-ce que ce syst√®me ?'},
          {id: 'doc-users', title: 'üë• Pour les Utilisateurs'},
          {id: 'doc-admins', title: 'üîß Pour les Administrateurs'},
          {id: 'doc-security', title: 'üîí Fonctionnalit√©s de S√©curit√©'},
          {id: 'doc-benefits', title: '‚ö° Avantages Cl√©s'},
          {id: 'doc-faq', title: 'üí° Questions Fr√©quentes'},
          {id: 'doc-best-practices', title: 'üöÄ Meilleures Pratiques'},
          {id: 'doc-technical', title: 'üìä Sp√©cifications Techniques'}
        ];

        sections.forEach(sec => {
          const contentEl = doc.getElementById(sec.id);
          if (contentEl) {
            const item = document.createElement('div');
            item.className = 'accordion-item';
            item.innerHTML = `
              <div class="accordion-header" onclick="toggleAccordion(this)">
                <span>${sec.title}</span>
                <span class="accordion-icon">+</span>
              </div>
              <div class="accordion-content">
                ${contentEl.innerHTML}
              </div>
            `;
            container.appendChild(item);
          }
        });

      }).recupererHtmlDocumentation();
    }

    function toggleAccordion(header) {
      const content = header.nextElementSibling;
      const isActive = header.classList.contains('active');
      
      // Fermer tous
      document.querySelectorAll('.accordion-header').forEach(h => h.classList.remove('active'));
      document.querySelectorAll('.accordion-content').forEach(c => c.classList.remove('active'));
      
      // Ouvrir cliqu√©
      if (!isActive) {
        header.classList.add('active');
        content.classList.add('active');
      }
    }

    // --- GESTION INTERFACE ---
    function switchTab(tabName) {
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      
      document.getElementById(tabName + '-panel').classList.add('active');
      document.querySelector('.tab-button.' + tabName).classList.add('active');
    }

    function switchTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
    }

    // --- AUTHENTIFICATION ---
    function handleLogin() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      const btn = document.querySelector('.btn-login');

      if(!email || !pass) { alert('Champs manquants'); return; }

      const oldText = btn.textContent;
      btn.textContent = 'Connexion...';
      btn.disabled = true;

      google.script.run
        .withSuccessHandler(res => {
          btn.textContent = oldText;
          btn.disabled = false;
          if(res.succes) {
            currentUser = res;
            sessionStorage.setItem('userSession', JSON.stringify(res));
            unlockInterface(res);
            alert('Connexion r√©ussie !');
            // Nettoyage
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
          } else {
            alert('Erreur : ' + res.message);
          }
        })
        .withFailureHandler(err => {
          btn.textContent = oldText;
          btn.disabled = false;
          alert('Erreur syst√®me : ' + err.message);
        })
        .connecterUtilisateur(email, pass);
    }

    function unlockInterface(user) {
      // D√©verrouiller User
      document.getElementById('user-lock-screen').style.display = 'none';
      document.getElementById('user-content').style.display = 'block';
      
      // Charger feuilles
      loadUserSheets();

      // D√©verrouiller Admin si besoin
      if(user.estAdmin) {
        document.getElementById('admin-lock-screen').style.display = 'none';
        document.getElementById('admin-content').style.display = 'block';
        loadAdminData();
        switchTab('admin');
      } else {
        switchTab('users');
      }
    }

    function handleLogout() {
      if(confirm('Se d√©connecter ?')) {
        google.script.run.deconnecterUtilisateur(currentUser.jetonSession);
        sessionStorage.removeItem('userSession');
        window.location.reload();
      }
    }

    // --- FONCTIONS UTILISATEUR ---
    function loadUserSheets() {
      // Note : Assurez-vous que recupererFeuillesDisponibles est impl√©ment√©e dans Code.gs
      // Sinon, adaptez pour utiliser recupererDonneesTableauBord si admin, ou autre.
      const select = document.getElementById('sheet-select');
      select.innerHTML = '<option>Chargement...</option>';

      google.script.run.withSuccessHandler(res => {
        select.innerHTML = '<option value="">-- Choisir une feuille --</option>';
        if(res.succes && res.feuilles) {
          res.feuilles.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f.id;
            opt.textContent = f.nom + (f.inUse ? ' (Occup√©)' : '');
            if(f.inUse) opt.disabled = true;
            select.appendChild(opt);
          });
        }
      }).recupererFeuillesDisponibles(currentUser.jetonSession);
    }

    function requestAccess() {
      const id = document.getElementById('sheet-select').value;
      if(!id) return;
      
      const msg = document.getElementById('user-msg');
      msg.style.display = 'block';
      msg.className = 'status-message';
      msg.textContent = 'Demande en cours...';

      google.script.run.withSuccessHandler(res => {
        if(res.succes) {
          msg.className = 'status-message success';
          msg.textContent = res.message;
          window.open(res.urlFeuille, '_blank');
          loadUserSheets(); // Refresh
        } else {
          msg.className = 'status-message error';
          msg.textContent = res.message;
        }
      }).demanderAccesFeuille(id, currentUser.jetonSession);
    }

    // --- FONCTIONS ADMIN ---
    function loadAdminData() {
      const div = document.getElementById('admin-stats');
      div.innerHTML = 'Chargement...';
      google.script.run.withSuccessHandler(res => {
        if(res.succes) {
          div.innerHTML = `
            <strong>Utilisateurs :</strong> ${res.utilisateurs.length}<br>
            <strong>Feuilles :</strong> ${res.feuilles.length}<br>
            <strong>Stockage :</strong> ${res.stockage.pourcentageUtilise}%
          `;
        }
      }).recupererDonneesTableauBord(currentUser.jetonSession);
    }

    // --- MODALES ---
    function openRegistrationModal() { document.getElementById('reg-modal').style.display = 'block'; }
    function closeRegistrationModal() { document.getElementById('reg-modal').style.display = 'none'; }
    
    function submitRegistration() {
      const nom = document.getElementById('reg-name').value;
      const email = document.getElementById('reg-email').value;
      const pass = document.getElementById('reg-pass').value;

      google.script.run.withSuccessHandler(res => {
        alert(res.message);
        if(res.succes) closeRegistrationModal();
      }).inscrireNouvelUtilisateur(email, pass, nom);
    }

    // Fermeture clic ext√©rieur
    window.onclick = function(e) {
      if(e.target == document.getElementById('reg-modal')) closeRegistrationModal();
    }
  </script>
</body>
</html>
